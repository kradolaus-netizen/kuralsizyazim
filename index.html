<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="TDK uyumlu yazÄ±m kurallarÄ± oyunu. KaldÄ±ÄŸÄ±n yerden devam et!">
  <title>KuralsÄ±z YazÄ±m - Yerel KayÄ±t</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* CORE */
    body { font-family: 'Nunito', sans-serif; overflow: hidden; user-select: none; }
    
    /* ANIMATIONS */
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    
    /* UI COMPONENTS */
    .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .bg-paper .glass-panel { background: rgba(255, 251, 235, 0.95); border-color: #b45309; box-shadow: 0 10px 30px rgba(69, 26, 3, 0.1); }
    
    .btn-option { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; cursor: pointer; }
    @media (hover: hover) { .btn-option:hover { transform: scale(1.02); background: rgba(255,255,255,0.2); } }
    .btn-option:active { transform: scale(0.96); }
    
    /* STATES */
    .state-correct { background: #10b981 !important; color: white !important; border-color: transparent !important; }
    .state-wrong { background: #ef4444 !important; color: white !important; border-color: transparent !important; opacity: 0.9; }
    .strike-through { text-decoration: line-through; text-decoration-thickness: 3px; opacity: 0.7; }
    .icon-feedback { display: inline-flex; width: 24px; height: 24px; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.2); margin-left: 8px; font-size: 0.8rem; }

    /* THEMES */
    .theme-transition { transition: background 1s ease, color 0.3s ease; }
    .bg-aurora-purple { background: linear-gradient(-45deg, #6366f1, #a855f7, #ec4899); background-size: 400% 400%; animation: gradientMove 20s infinite; color: white; }
    .bg-aurora-green { background: linear-gradient(-45deg, #10b981, #3b82f6, #06b6d4); background-size: 400% 400%; animation: gradientMove 20s infinite; color: white; }
    .bg-paper { background: #fdf6e3 url("https://www.transparenttextures.com/patterns/old-map.png"); color: #451a03; }
    .bg-paper .glass-panel { background: rgba(255, 251, 235, 0.98); border-color: #b45309; }
    .question-card { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    
    .key-hint { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; opacity: 0.4; font-weight: bold; border: 1px solid currentColor; padding: 2px 6px; rounded: 4px; }
  </style>
</head>
<body id="app-body" class="h-full w-full bg-aurora-purple theme-transition">

  <div id="audio-container" hidden>
    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-wrong" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sfx-level" src="https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3"></audio>
    <audio id="sfx-fail" src="https://assets.mixkit.co/active_storage/sfx/2030/2030-preview.mp3"></audio>
  </div>

  <div id="app" class="h-full flex flex-col relative max-w-4xl mx-auto">
    
    <div id="overlay-level" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-xl hidden">
      <h2 id="overlay-title" class="text-5xl md:text-6xl font-black text-white mb-2 animate-[popIn_0.5s_ease]">AÅAMA 1</h2>
      <p id="overlay-sub" class="text-indigo-400 font-bold tracking-widest uppercase">HazÄ±rlan...</p>
    </div>

    <section id="view-landing" class="absolute inset-0 z-40 flex flex-col items-center justify-center p-6 bg-black/60 backdrop-blur-lg">
      <header class="w-full flex justify-between items-center absolute top-6 px-6">
        <div class="flex gap-2">
           <div class="bg-white/10 px-3 py-1 rounded-lg text-white text-xs font-bold border border-white/20 flex items-center gap-1 cursor-default">
             ğŸ’ <span id="stat-score">0</span>
           </div>
           <div class="bg-white/10 px-3 py-1 rounded-lg text-white text-xs font-bold border border-white/20 flex items-center gap-1 cursor-default">
             ğŸ”¥ <span id="stat-streak">0</span>
           </div>
        </div>
        <button onclick="window.App.UI.toggleShop(true)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-full font-bold shadow-lg text-sm hover:scale-105 transition-transform cursor-pointer">ğŸ›’ DÃ¼kkan</button>
      </header>

      <div class="text-center mb-10">
        <h1 class="text-6xl md:text-8xl font-black text-white mb-2 tracking-tighter italic drop-shadow-2xl cursor-default text-center">KURALSIZ</h1>
        <p class="text-white/70 mb-10 font-semibold text-lg cursor-default text-center">DoÄŸruyu bul, yanlÄ±ÅŸÄ± Ã§iz. âœï¸</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-lg">
        <button onclick="window.App.Engine.start('normal')" class="glass-panel p-8 rounded-3xl text-left hover:bg-white/20 transition-all group text-white cursor-pointer hover:scale-105 relative">
          <span class="text-4xl mb-3 block">ğŸ§˜â€â™‚ï¸</span>
          <h3 id="btn-journey-title" class="text-2xl font-bold">Yolculuk</h3>
          <p id="btn-journey-desc" class="text-sm opacity-70 mt-1">KaldÄ±ÄŸÄ±n yerden devam et</p>
          <div id="journey-progress" class="absolute bottom-0 left-0 h-1 bg-green-500 transition-all" style="width: 0%"></div>
        </button>
        <button onclick="window.App.Engine.start('timer')" class="glass-panel p-8 rounded-3xl text-left hover:bg-white/20 transition-all group text-white relative overflow-hidden cursor-pointer hover:scale-105">
          <div class="absolute top-0 right-0 bg-yellow-500 text-black text-[10px] font-bold px-2 py-1 rounded-bl-lg">POPÃœLER</div>
          <span class="text-4xl mb-3 block">âš¡</span>
          <h3 class="text-2xl font-bold">YÄ±ldÄ±rÄ±m</h3>
          <p class="text-sm opacity-70 mt-1">30 Saniye â€¢ Seri Bonusu</p>
        </button>
      </div>
      
      <button onclick="window.App.Engine.resetProgress()" class="absolute bottom-6 text-white/20 text-xs font-mono hover:text-white/50 underline cursor-pointer">
        Ä°lerlememi SÄ±fÄ±rla
      </button>
    </section>

    <header id="view-header" class="relative z-10 px-6 pt-10 pb-4 flex items-center justify-between hidden">
      <div class="flex items-center gap-3">
        <button onclick="window.App.Engine.quit()" class="bg-red-500/20 text-red-100 px-3 py-1 rounded-full text-xs font-bold hover:bg-red-500 transition-colors cursor-pointer">Ã‡IK</button>
        <div class="flex flex-col cursor-default">
          <span id="hud-mode" class="text-[10px] font-bold uppercase tracking-widest opacity-70">AÅAMA 1</span>
          <div id="hud-lives" class="flex gap-1 text-red-400 text-sm h-4"></div>
        </div>
      </div>
      <div class="flex gap-3 items-center cursor-default">
        <div id="hud-timer" class="hidden bg-red-600 text-white px-3 py-1 rounded-lg font-mono font-bold shadow-lg text-sm">30s</div>
        <div class="glass-panel px-4 py-1 rounded-lg font-black border border-white/20 text-lg"><span id="hud-score">0</span></div>
      </div>
    </header>

    <main id="view-game" class="relative z-10 flex-1 px-4 flex flex-col justify-center max-w-2xl mx-auto w-full hidden">
      <div class="glass-panel rounded-[2.5rem] p-8 shadow-2xl relative">
        <div id="feedback-bar" class="absolute -top-5 left-1/2 -translate-x-1/2 bg-white text-indigo-900 px-6 py-2 rounded-full font-black shadow-lg scale-0 transition-transform whitespace-nowrap z-20 text-sm pointer-events-none">HARÄ°KA!</div>
        <p id="question-text" class="text-2xl md:text-4xl font-black text-center leading-tight min-h-[5rem] flex items-center justify-center cursor-default">YÃ¼kleniyor...</p>
        <div id="options-grid" class="grid grid-cols-1 gap-3 mt-4"></div>
        <button id="btn-next" onclick="window.App.Engine.next()" class="w-full py-4 mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-xl shadow-lg hidden transition-all hover:scale-[1.02] cursor-pointer">DEVAM ET (Space)</button>
      </div>
    </main>

    <section id="view-summary" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/95 backdrop-blur-xl text-center hidden text-white">
      <div class="text-6xl mb-4 animate-[float_3s_infinite]">ğŸ†</div>
      <h2 id="sum-title" class="text-4xl font-black mb-2">Harika Ä°ÅŸ!</h2>
      <div class="flex gap-4 mb-8 w-full max-w-sm justify-center">
        <div class="bg-white/10 p-4 rounded-2xl border border-white/10 min-w-[120px]"><div class="text-[10px] uppercase opacity-50">Puan</div><div id="sum-score" class="text-3xl font-black">0</div></div>
        <div class="bg-white/10 p-4 rounded-2xl border border-white/10 min-w-[120px]"><div class="text-[10px] uppercase opacity-50">Hatalar</div><div id="sum-mistakes" class="text-3xl font-black text-red-400">0</div></div>
      </div>
      <button onclick="location.reload()" class="w-full max-w-xs py-4 bg-white text-indigo-900 font-black rounded-xl hover:scale-105 transition-transform cursor-pointer shadow-xl">ANA MENÃœYE DÃ–N</button>
    </section>

    <div id="modal-shop" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-md flex items-end sm:items-center justify-center p-4 hidden">
      <div class="bg-[#1e1b4b] w-full max-w-md rounded-3xl border border-white/10 p-6 max-h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-white">Market</h2><button onclick="window.App.UI.toggleShop(false)" class="text-white/50 hover:text-white text-2xl p-2 cursor-pointer">âœ•</button></div>
        <h3 class="text-xs font-bold text-indigo-300 uppercase mb-3">GÃ¼Ã§lendirmeler</h3><div id="shop-buffs" class="space-y-3 mb-6"></div>
        <h3 class="text-xs font-bold text-indigo-300 uppercase mb-3">Temalar</h3><div id="shop-themes" class="grid grid-cols-2 gap-3"></div>
      </div>
    </div>
  </div>

  <script>
    /** --- MODULE: DATA --- */
    const Data = {
      words: {
         easy: [
        {id:1,correct:'yalnÄ±z',wrong:'yanlÄ±z'},{id:2,correct:'yanlÄ±ÅŸ',wrong:'yalnÄ±ÅŸ'},{id:3,correct:'herkes',wrong:'herkez'},{id:4,correct:'sÃ¼rpriz',wrong:'sÃ¼priz'},
        {id:5,correct:'tÄ±raÅŸ',wrong:'traÅŸ'},{id:6,correct:'makine',wrong:'makina'},{id:7,correct:'meyve',wrong:'meyva'},{id:8,correct:'grup',wrong:'gurup'},
        {id:9,correct:'direkt',wrong:'direk'},{id:10,correct:'poÄŸaÃ§a',wrong:'pohaÃ§a'},{id:11,correct:'elektrik',wrong:'elektirik'},{id:12,correct:'fantezi',wrong:'fantazi'},
        {id:13,correct:'fasulye',wrong:'fasulye'},{id:14,correct:'kavanoz',wrong:'gavanoz'},{id:15,correct:'materyal',wrong:'mataryel'},{id:16,correct:'espri',wrong:'espiri'},
        {id:17,correct:'idman',wrong:'itman'},{id:18,correct:'eÅŸofman',wrong:'eÅŸortman'},{id:19,correct:'etÃ¼t',wrong:'etÃ¼d'},{id:20,correct:'lavabo',wrong:'lavobo'}
      ],
      medium: [
        {id:21,correct:'inisiyatif',wrong:'insiyatif'},{id:22,correct:'orijinal',wrong:'orjinal'},{id:23,correct:'entelektÃ¼el',wrong:'entellektÃ¼el'},{id:24,correct:'dokÃ¼man',wrong:'dÃ¶kÃ¼man'},
        {id:25,correct:'antrenman',wrong:'antreman'},{id:26,correct:'unvan',wrong:'Ã¼nvan'},{id:27,correct:'vejetaryen',wrong:'vejeteryan'},{id:28,correct:'restoran',wrong:'restorant'},
        {id:29,correct:'ÅŸofÃ¶r',wrong:'ÅŸÃ¶fÃ¶r'},{id:30,correct:'laboratuvar',wrong:'labaratuar'},{id:31,correct:'egzoz',wrong:'egsos'},{id:32,correct:'rÃ¶nesans',wrong:'rÃ¶nasans'},
        {id:33,correct:'nispet',wrong:'nisbet'},{id:34,correct:'ÅŸefkat',wrong:'ÅŸevkat'},{id:35,correct:'sarimsak',wrong:'sarmÄ±sak'},{id:36,correct:'asfalt',wrong:'asvalt'},
        {id:37,correct:'ÅŸofben',wrong:'ÅŸofpen'},{id:38,correct:'tetanos',wrong:'tetanoz'},{id:39,correct:'maydanoz',wrong:'maydonoz'},{id:40,correct:'tespih',wrong:'tesbih'},
        {id:41,correct:'naif',wrong:'nahif'},{id:42,correct:'peÅŸtamal',wrong:'peÅŸtemal'},{id:43,correct:'provokatÃ¶r',wrong:'provakatÃ¶r'},{id:44,correct:'mevlit',wrong:'mevlÃ¼d'}
      ],
      hard: [
        {id:45,correct:'karnabahar',wrong:'karnÄ±bahar'},{id:46,correct:'gardÄ±rop',wrong:'gardrop'},{id:47,correct:'atardamar',wrong:'atar damar'},{id:48,correct:'ana dil',wrong:'anadil'},
        {id:49,correct:'anayasa',wrong:'ana yasa'},{id:50,correct:'denizanasÄ±',wrong:'deniz anasÄ±'},{id:51,correct:'hoÅŸgÃ¶rÃ¼',wrong:'hoÅŸ gÃ¶rÃ¼'},{id:52,correct:'Ã¶zbeÃ¶z',wrong:'Ã¶z be Ã¶z'},
        {id:53,correct:'anbean',wrong:'an be an'},{id:54,correct:'gÃ¼nbegÃ¼n',wrong:'gÃ¼n be gÃ¼n'},{id:55,correct:'sÄ±ra dÄ±ÅŸÄ±',wrong:'sÄ±radÄ±ÅŸÄ±'},{id:56,correct:'yani sÄ±ra',wrong:'yanÄ±sÄ±ra'},
        {id:57,correct:'mÃ¼svedde',wrong:'mÃ¼svette'},{id:58,correct:'kurdele',wrong:'kordele'},{id:59,correct:'kupÃ¼r',wrong:'kÃ¼pÃ¼r'},{id:60,correct:'rastlantÄ±',wrong:'raslantÄ±'},
        {id:61,correct:'iddia',wrong:'idda'},{id:62,correct:'acente',wrong:'acenta'},{id:63,correct:'zatÃ¼rre',wrong:'zatÃ¼re'},{id:64,correct:'rÃ¶gar',wrong:'logar'},
        {id:65,correct:'tazyik',wrong:'tazzik'},{id:66,correct:'bilinÃ§altÄ±',wrong:'bilinÃ§ altÄ±'},{id:67,correct:'saÄŸduyu',wrong:'saÄŸ duyu'},{id:68,correct:'eÅŸ anlam',wrong:'eÅŸanlam'},
        {id:69,correct:'Ã¶nsezi',wrong:'Ã¶n sezi'},{id:70,correct:'dil bilimi',wrong:'dilbilimi'},{id:71,correct:'sÃ¶z konusu',wrong:'sÃ¶zkonusu'},{id:72,correct:'gÃ¶zyaÅŸÄ±',wrong:'gÃ¶z yaÅŸÄ±'},
        {id:73,correct:'birdenbire',wrong:'birden bire'},{id:74,correct:'Ã¶rtbas',wrong:'Ã¶rt bas'},{id:75,correct:'pÃ¼rdikkat',wrong:'pÃ¼r dikkat'},{id:76,correct:'hasbihÃ¢l',wrong:'hasbihal'},
        {id:77,correct:'sandviÃ§',wrong:'sandÃ¼viÃ§'},{id:78,correct:'biskÃ¼vi',wrong:'pÃ¼skÃ¼vi'},{id:79,correct:'dinozor',wrong:'dinazor'},{id:80,correct:'erozyon',wrong:'erazyon'},
        {id:81,correct:'iÃ§gÃ¶rÃ¼',wrong:'iÃ§ gÃ¶rÃ¼'},{id:82,correct:'Ã¶ngÃ¶rÃ¼',wrong:'Ã¶n gÃ¶rÃ¼'},{id:83,correct:'saÄŸgÃ¶rÃ¼',wrong:'saÄŸ gÃ¶rÃ¼'},{id:84,correct:'Ã¶nayak',wrong:'Ã¶n ayak'},
        {id:85,correct:'Ã¶n sÃ¶z',wrong:'Ã¶nsÃ¶z'},{id:86,correct:'Ã¶n yargÄ±',wrong:'Ã¶nyargÄ±'},{id:87,correct:'stajyer',wrong:'stajer'},{id:88,correct:'pardÃ¶sÃ¼',wrong:'pardÃ¼sÃ¼'},
        {id:89,correct:'kravat',wrong:'gravat'},{id:90,correct:'zarafet',wrong:'zerafet'},{id:91,correct:'komiser',wrong:'komser'},{id:92,correct:'konservatuvar',wrong:'konservatuar'},
        {id:93,correct:'ortaÃ¶ÄŸretim',wrong:'orta Ã¶ÄŸretim'},{id:94,correct:'Ã¶zdeyiÅŸ',wrong:'Ã¶z deyiÅŸ'},{id:95,correct:'Ã¶z eleÅŸtiri',wrong:'Ã¶zeleÅŸtiri'},{id:96,correct:'Ã¶z geÃ§miÅŸ',wrong:'Ã¶zgeÃ§miÅŸ'},
        {id:97,correct:'Ã¶z gÃ¼ven',wrong:'Ã¶zgÃ¼ven'},{id:98,correct:'Ã¶z saygÄ±',wrong:'Ã¶zsaygÄ±'},{id:99,correct:'Ã¶zveri',wrong:'Ã¶z veri'},{id:100,correct:'Ã¶z yaÅŸam',wrong:'Ã¶zyaÅŸam'},
        {id:101,correct:'iÃ§gÃ¼dÃ¼',wrong:'iÃ§ gÃ¼dÃ¼'},{id:102,correct:'iÃ§yÃ¼z',wrong:'iÃ§ yÃ¼z'},{id:103,correct:'sÄ±radaÄŸ',wrong:'sÄ±ra daÄŸ'},{id:104,correct:'bÃ¼yÃ¼kanne',wrong:'bÃ¼yÃ¼k anne'},
        {id:105,correct:'bÃ¼yÃ¼kbaba',wrong:'bÃ¼yÃ¼k baba'},{id:106,correct:'bÃ¼yÃ¼kelÃ§i',wrong:'bÃ¼yÃ¼k elÃ§i'},{id:107,correct:'bÃ¼yÃ¼kÅŸehir',wrong:'bÃ¼yÃ¼k ÅŸehir'},{id:108,correct:'silahÅŸor',wrong:'silahÅŸÃ¶r'},
        {id:109,correct:'kolektif',wrong:'kollektif'},{id:110,correct:'mÃ¼spet',wrong:'mÃ¼sbet'},{id:111,correct:'seyahat',wrong:'seyehat'},{id:112,correct:'adale',wrong:'adele'},
        {id:114,correct:'tehdit',wrong:'tehtit'},{id:115,correct:'acayip',wrong:'acaip'},{id:116,correct:'altyapÄ±',wrong:'alt yapÄ±'},
        {id:117,correct:'ayakaltÄ±',wrong:'ayak altÄ±'},{id:118,correct:'Ã¼stÃ§avuÅŸ',wrong:'Ã¼st Ã§avuÅŸ'},{id:119,correct:'Ã¼stsubay',wrong:'Ã¼st subay'},{id:120,correct:'binbir',wrong:'bin bir'},
        {id:121,correct:'peÅŸi sÄ±ra',wrong:'peÅŸisÄ±ra'},{id:122,correct:'yarÄ±Ã§ap',wrong:'yarÄ± Ã§ap'},{id:123,correct:'katetmek',wrong:'kat etmek'},{id:124,correct:'cibilliyet',wrong:'cibiliyet'},
        {id:125,correct:'el Ã¢lem',wrong:'elalem'},{id:126,correct:'defetmek',wrong:'def etmek'},{id:127,correct:'menetmek',wrong:'men etmek'},{id:128,correct:'on binlerce',wrong:'onbinlerce'},
        {id:129,correct:'gÃ¶zlemevi',wrong:'gÃ¶zlem evi'},{id:130,correct:'darbetmek',wrong:'darp etmek'},{id:131,correct:'sugÃ¶tÃ¼rmez',wrong:'su gÃ¶tÃ¼rmez'},{id:132,correct:'tez canlÄ±',wrong:'tezcanlÄ±'},
        {id:133,correct:'maiyet',wrong:'mahiyet'},{id:134,correct:'deÄŸerbilmezlik',wrong:'deÄŸer bilmezlik'},{id:135,correct:'zabÄ±t kÃ¢tibi',wrong:'zabÄ±t katibi'},{id:136,correct:'Ã‡oban YÄ±ldÄ±zÄ±',wrong:'Ã‡obanyÄ±ldÄ±zÄ±'}
      ]
      },
      shop: {
        themes: [
          {id:'bg-aurora-purple', name:'Klasik Mor', cost:0, desc:'VarsayÄ±lan'},
          {id:'bg-aurora-green', name:'DoÄŸa YeÅŸili', cost:500, desc:'FerahlatÄ±cÄ±'},
          {id:'bg-paper', name:'Antik KaÄŸÄ±t', cost:2000, desc:'Akademik His'}
        ],
        buffs: [
          {id:'life', name:'â¤ï¸ +1 Can (Boss)', cost: 100, desc:'Boss toleransÄ±.'},
          {id:'time', name:'â±ï¸ +10sn (Timer)', cost: 150, desc:'Ekstra sÃ¼re.'}
        ]
      }
    };

    const ALL_WORDS = [...Data.words.easy, ...Data.words.medium, ...Data.words.hard];

    /** --- STATE LAYER --- */
    const State = {
      // VarsayÄ±lan deÄŸerler
      data: { totalScore: 0, maxStreak: 0, equippedTheme: 'bg-aurora-purple', failedWords: {}, inventory: { life: 0, time: 0 }, unlocks: ['bg-aurora-purple'], currentStage: 0 },
      load() { const s=localStorage.getItem('ky_save_v10'); if(s) this.data={...this.data,...JSON.parse(s)}; },
      save() { localStorage.setItem('ky_save_v10', JSON.stringify(this.data)); },
      addMistake(id) { this.data.failedWords[id]=(this.data.failedWords[id]||0)+1; this.save(); },
      resetProgress() {
          if(confirm("TÃ¼m oyun ilerlemen sÄ±fÄ±rlansÄ±n mÄ±?")) {
              this.data.currentStage = 0;
              this.save();
              location.reload();
          }
      }
    };

    /** --- UI LAYER --- */
    const UI = {
      $: (id) => document.getElementById(id),
      init() { 
          State.load(); 
          this.applyTheme(State.data.equippedTheme); 
          this.updateStats();
          this.updateJourneyButton();
      },
      showScreen(id) { ['view-landing','view-header','view-game','view-summary'].forEach(s=>this.$(s).classList.add('hidden')); this.$(id).classList.remove('hidden'); },
      applyTheme(t) { document.body.className=document.body.className.replace(/bg-[\w-]+/g, t); document.body.style.color=t.includes('paper')?'#451a03':'white'; },
      updateStats() { this.$('stat-score').textContent=State.data.totalScore; this.$('stat-streak').textContent=State.data.maxStreak; },
      
      // Dinamik "Yolculuk" Butonu
      updateJourneyButton() {
          const stage = State.data.currentStage;
          const stages = ["Kolay", "Orta", "Zor", "Bitti"];
          const label = stage < 3 ? stages[stage] : "Bitti";
          
          if(stage > 0 && stage < 3) {
              this.$('btn-journey-title').textContent = "Devam Et";
              this.$('btn-journey-desc').textContent = `${label} AÅŸamadan BaÅŸla`;
              // Ä°lerleme Ã§ubuÄŸu
              this.$('journey-progress').style.width = ((stage / 3) * 100) + "%";
          } else if (stage >= 3) {
              this.$('btn-journey-title').textContent = "TamamlandÄ±!";
              this.$('btn-journey-desc').textContent = "TÃ¼m aÅŸamalar bitti.";
              this.$('journey-progress').style.width = "100%";
          }
      },

      showFeedback(msg, type) {
        const fb=this.$('feedback-bar'); fb.textContent=msg;
        fb.className=`absolute -top-5 left-1/2 -translate-x-1/2 px-6 py-2 rounded-full font-black shadow-lg scale-100 transition-transform whitespace-nowrap z-20 text-sm ${type==='good'?'bg-green-500 text-white':'bg-red-500 text-white'}`;
        setTimeout(()=>fb.classList.add('scale-0'), 1200);
      },
      toggleShop(s) { const m=this.$('modal-shop'); if(s){this.renderShop(); m.classList.remove('hidden');}else m.classList.add('hidden'); },
      renderShop() {
        this.$('shop-buffs').innerHTML=Data.shop.buffs.map(b=>`<div class="flex justify-between items-center p-3 bg-white/5 rounded-2xl border border-white/10"><div class="text-white"><div class="font-bold text-sm">${b.name}</div><div class="text-xs text-yellow-400">Stok: ${State.data.inventory[b.id]||0}</div></div><button onclick="window.App.Engine.buyItem('buff','${b.id}',${b.cost})" class="bg-indigo-600 hover:bg-indigo-500 px-3 py-2 rounded-lg text-white text-xs font-bold">${b.cost} ğŸ’ AL</button></div>`).join('');
        this.$('shop-themes').innerHTML=Data.shop.themes.map(t=>{
            const own=State.data.unlocks.includes(t.id), eq=State.data.equippedTheme===t.id;
            return `<div class="p-3 bg-white/5 rounded-2xl border ${eq?'border-green-500':'border-white/10'} text-center text-white"><div class="h-10 w-full mb-2 rounded-lg ${t.id} border border-white/20"></div><p class="font-bold text-xs mb-1">${t.name}</p><button onclick="window.App.Engine.buyItem('theme','${t.id}',${t.cost})" class="w-full py-1.5 ${eq?'bg-green-500':(own?'bg-indigo-600':'bg-gray-700')} rounded-lg font-bold text-[10px] uppercase">${eq?'AKTÄ°F':(own?'SEÃ‡':`${t.cost} ğŸ’`)}</button></div>`;
        }).join('');
      },
      renderHearts(c) { this.$('hud-lives').innerHTML='â¤ï¸'.repeat(c); }
    };

    /** --- ENGINE LAYER --- */
    const Engine = {
      state: { mode:null, subStage:'normal', score:0, streak:0, lives:3, timer:30, interval:null, pool:[], failed:[], currentQ:0, ended:false, usedWordIds:new Set() },
      sounds: { correct: document.getElementById('sfx-correct'), wrong: document.getElementById('sfx-wrong'), level: document.getElementById('sfx-level'), fail: document.getElementById('sfx-fail') },
      play(k) { if(this.sounds[k]){this.sounds[k].currentTime=0; this.sounds[k].play().catch(()=>{});} },

      buyItem(type, id, cost) {
        if(type!=='buff' && State.data.unlocks.includes(id)) { if(type==='theme'){State.data.equippedTheme=id; UI.applyTheme(id);} State.save(); UI.renderShop(); return; }
        if(State.data.totalScore>=cost) {
            State.data.totalScore-=cost;
            if(type==='buff') State.data.inventory[id]=(State.data.inventory[id]||0)+1; else { State.data.unlocks.push(id); if(type==='theme'){State.data.equippedTheme=id; UI.applyTheme(id);} }
            State.save(); UI.updateStats(); UI.renderShop();
        }
      },

      resetProgress() { State.resetProgress(); },

      start(mode) {
        this.state.ended=false; this.state.mode=mode; this.state.score=0; this.state.streak=0; this.state.failed=[];
        this.state.currentQ=0; this.state.usedWordIds.clear(); 
        
        UI.showScreen('view-game'); UI.$('view-header').classList.remove('hidden');
        
        if(mode==='timer') {
            const extra=State.data.inventory.time>0?10:0; if(extra>0){State.data.inventory.time--; State.save(); UI.showFeedback("â±ï¸ Boost Aktif!", "good");}
            this.state.pool=[...ALL_WORDS]; 
            this.state.timer=30+extra; UI.$('hud-timer').classList.remove('hidden'); this.startTimer();
        } else {
            UI.$('hud-timer').classList.add('hidden'); 
            // KaldÄ±ÄŸÄ± leveldan baÅŸla (eÄŸer bitmediyse)
            const startLvl = State.data.currentStage >= 3 ? 0 : State.data.currentStage;
            this.initLevel(startLvl);
        }
        UI.updateStats();
      },

      initLevel(lvl) {
        this.state.subStage='normal'; this.state.currentLevel=lvl; this.state.currentQ=0; this.state.failed=[]; 
        this.state.usedWordIds.clear(); 
        this.state.pool=Data.words[['easy','medium','hard'][lvl]].sort(()=>Math.random()-0.5).slice(0,20);
        
        const overlay=UI.$('overlay-level'); UI.$('overlay-title').textContent=["AÅAMA 1","AÅAMA 2","AÅAMA 3"][lvl];
        this.play('level'); overlay.classList.remove('hidden');
        setTimeout(()=>{overlay.classList.add('hidden'); this.nextQuestion();},1500);
        UI.$('hud-mode').textContent=UI.$('overlay-title').textContent; UI.renderHearts(0);
      },

      initBoss() {
        this.state.subStage='boss';
        const extra=State.data.inventory.life>0?1:0; if(extra>0){State.data.inventory.life--; State.save();}
        this.state.lives=3+extra; this.state.currentQ=0;
        this.state.pool=Data.words[['easy','medium','hard'][this.state.currentLevel]].sort(()=>0.5-Math.random()).slice(0,5);
        UI.renderHearts(this.state.lives);
        const overlay=UI.$('overlay-level'); UI.$('overlay-title').textContent="BOSS"; overlay.classList.remove('hidden');
        this.play('level');
        setTimeout(()=>{overlay.classList.add('hidden'); this.state.usedWordIds.clear(); this.nextQuestion();},1500);
      },

      initReview() {
        this.state.subStage='review'; this.state.pool=[...this.state.failed]; this.state.failed=[]; this.state.currentQ=0;
        const overlay=UI.$('overlay-level'); UI.$('overlay-title').textContent="TELAFÄ°"; overlay.classList.remove('hidden');
        setTimeout(()=>{overlay.classList.add('hidden'); this.nextQuestion();},1500);
      },

      next() {
        if(this.state.mode==='timer') { this.nextQuestion(); return; }
        
        this.state.currentQ++;
        
        if (this.state.mode === 'normal') {
            const limit = this.state.subStage === 'boss' ? 5 : this.state.pool.length;
            if (this.state.currentQ >= limit) {
                if (this.state.subStage === 'normal') {
                    this.state.failed.length > 0 ? this.initReview() : this.initBoss();
                } else if (this.state.subStage === 'review') {
                    this.initBoss();
                } else if (this.state.subStage === 'boss') {
                    // Boss bitti, level atla
                    if (this.state.currentLevel < 2) {
                        const nextLvl = this.state.currentLevel + 1;
                        // Ä°lerlemeyi kaydet
                        State.data.currentStage = nextLvl;
                        State.save();
                        this.initLevel(nextLvl);
                    } else {
                        // Oyun bitti
                        State.data.currentStage = 3; // 3 = Bitti
                        State.save();
                        this.endGame("YOLCULUK TAMAMLANDI!");
                    }
                }
                return;
            }
        }
        this.nextQuestion();
      },

      nextQuestion() {
        if(this.state.ended) return;
        UI.$('btn-next').classList.add('hidden');
        
        let word;
        if(this.state.mode === 'timer') {
             word = ALL_WORDS[Math.floor(Math.random() * ALL_WORDS.length)];
        } else {
             word = this.state.pool[this.state.currentQ];
        }

        if(!word) { console.error("Word Error"); return; } 
        this.currentWord = word; 

        const targetCorrect = Math.random()>0.5;
        UI.$('question-text').innerHTML = targetCorrect 
          ? `Hangisi <span class="text-green-500 underline decoration-4">DOÄRU</span>?` 
          : `Hangisi <span class="text-red-500 underline decoration-4">YANLIÅ</span>?`;

        const all = ALL_WORDS;
        const distractors = all.filter(w => w.id !== word.id).sort(()=>0.5-Math.random()).slice(0,3);
        
        let options = [];
        if(targetCorrect) {
            options = [{txt:word.c, isCorrect:true, meta:word}, ...distractors.map(d=>({txt:d.w, isCorrect:false, meta:d}))];
        } else {
            options = [{txt:word.w, isCorrect:true, meta:word}, ...distractors.map(d=>({txt:d.c, isCorrect:false, meta:d}))];
        }
        
        const grid=UI.$('options-grid'); grid.innerHTML='';
        options.sort(()=>0.5-Math.random()).forEach((opt,idx)=>{
            const btn=document.createElement('button');
            btn.className="btn-option glass-panel p-4 rounded-xl text-lg font-bold text-indigo-900 dark:text-white flex justify-between items-center w-full focus-ring hover:bg-white/20";
            btn.innerHTML=`<span class="pointer-events-none">${opt.txt}</span> <span class="text-xs opacity-50 border border-current px-1 rounded hidden md:inline-block">${idx+1}</span>`;
            btn.onclick=()=>this.handleChoice(opt, btn, options); 
            grid.appendChild(btn);
        });
      },

      handleChoice(choice, btn, allOptions) {
        if(!UI.$('btn-next').classList.contains('hidden')) return;

        if(choice.isCorrect) {
            this.state.score+=10; this.state.streak++; this.play('correct');
            btn.classList.add('state-correct'); btn.innerHTML+=`<span class="icon-feedback">âœ”</span>`;
            UI.showFeedback(this.state.streak%5===0?'SERÄ° BONUSU!':'HARÄ°KA!','good');
            if(this.state.mode==='timer'){this.state.timer+=1; UI.$('hud-timer').textContent=Math.ceil(this.state.timer)+'s';}
        } else {
            this.state.streak=0; this.play('wrong');
            btn.classList.add('state-wrong','animate-[shake_0.4s]'); btn.innerHTML+=`<span class="icon-feedback">âœ–</span>`;
            UI.showFeedback('DÄ°KKAT!','bad');
            
            if(this.state.subStage==='normal') this.state.failed.push(this.currentWord);
            State.addMistake(this.currentWord.id);

            if(this.state.subStage==='boss'){
                this.state.lives--; UI.renderHearts(this.state.lives);
                if(this.state.lives<=0){this.play('fail'); setTimeout(()=>this.initBoss(),1500); return;}
            }
        }

        Array.from(UI.$('options-grid').children).forEach((b,i)=>{
            const opt = allOptions[i];
            if(opt.txt === opt.meta.w) {
                b.innerHTML = `<span class="strike-through">${opt.txt}</span> <span class="ml-2 text-green-400 font-black">â†’ ${opt.meta.c}</span>`;
            }
        });

        UI.$('hud-score').textContent=this.state.score; State.save();
        if(this.state.mode==='timer') setTimeout(()=>this.next(),1200); else {UI.$('btn-next').classList.remove('hidden'); UI.$('btn-next').focus();}
      },

      startTimer() {
        if(this.state.interval) clearInterval(this.state.interval);
        this.state.interval=setInterval(()=>{
            this.state.timer-=1; UI.$('hud-timer').textContent=Math.ceil(this.state.timer)+'s';
            if(this.state.timer<=0) this.endGame("SÃœRE DOLDU");
        },1000); this.nextQuestion();
      },

      quit() { this.endGame("YARI KESÄ°LDÄ°"); },

      endGame(reason) {
        if(this.state.ended) return; this.state.ended=true;
        clearInterval(this.state.interval); State.data.totalScore+=this.state.score;
        if(this.state.streak>State.data.maxStreak) State.data.maxStreak=this.state.streak; State.save();
        UI.showScreen('view-summary'); UI.$('sum-title').textContent=reason;
        UI.$('sum-score').textContent=this.state.score; UI.$('sum-mistakes').textContent=this.state.failed.length;
        UI.updateStats();
      }
    };

    // --- INIT ---
    window.App = { UI, Data, Engine, State };
    document.addEventListener('keydown', (e) => {
      if(!UI.$('view-game').classList.contains('hidden')){
        if(['1','2','3','4'].includes(e.key)){ const bs=UI.$('options-grid').children; if(bs[e.key-1]) bs[e.key-1].click(); }
        if((e.key===' '||e.key==='Enter')&&!UI.$('btn-next').classList.contains('hidden')) Engine.next();
      }
    });
    window.onload = () => UI.init();
  </script>
</body>
</html>

